# Perspective Demo — Project Brief

## What is this?

A standalone web app that simulates the **Perspective** platform (by Insula/PSTPF) used by Eden Brae Homes for their supply chain. This demo acts as an **OIDC Identity Provider** so we can test SSO integration with the TradeStart Rewards loyalty portal (hosted on the Novus Loyalty platform).

In the real world, Eden Brae Homes' subcontractors (bricklayers, painters, carpenters etc.) log into Perspective to manage their jobs, invoices, and documents. Perspective is built by a company called Insula. This demo simulates that platform and its identity provider (PSTPF).

## Tech Stack

- **Framework:** Next.js 14 (App Router, TypeScript)
- **Styling:** Tailwind CSS
- **JWT:** `jose` library (RSA signing + verification)
- **Password hashing:** `bcrypt`
- **Deployment:** Vercel
- **Database:** None — in-memory user store + auth code store

## Pages

### 1. Login Page (`/login`)
- Email + password form
- Clean, professional UI (dark navy header, white card)
- Header shows "Perspective" branding (simple text logo)
- On success → redirect to `/dashboard`
- Session stored in httpOnly cookie (`perspective_session`, 24h expiry, signed JWT)

### 2. Dashboard (`/dashboard`)
- Must be authenticated (redirect to /login if no session)
- Header: "Perspective" logo + user name + Logout button
- Main content:
  - **Welcome banner:** "Welcome to Perspective" with brief description: "Your supply chain management portal for Eden Brae Homes and Connect Homes projects"
  - **Profile card:** Shows all user profile fields (name, email, mobile, address, company, ABN, vendor ID, trading name)
  - **TradeStart card:** Gold/yellow accent card with:
    - "TradeStart Rewards" heading
    - Brief description: "Access your TradeStart rewards, check your points balance, and redeem rewards"
    - **"Go to TradeStart Rewards"** button → links to TradeStart portal URL (env var `TRADESTART_PORTAL_URL`)
  - **Other placeholder cards** (to make it feel like a real platform):
    - "My Jobs" — "View your current and completed projects" (greyed out / coming soon)
    - "Invoices" — "Track your invoice status and payments" (greyed out / coming soon)
    - "Documents" — "Access project documentation" (greyed out / coming soon)

### 3. Password Reset (`/idp/resetpassword`)
- Simple placeholder page: "Password reset would be handled by the real Perspective platform"
- Shows the client_id from query params
- Link back to login

## OIDC Identity Provider Endpoints (API Routes)

All defined in `OIDC-SPEC.md`. These are the core of the demo — they implement a real OIDC Authorization Code + PKCE flow.

**IMPORTANT:** The OIDC endpoints must be accessible at their standard paths (not under /api/):
- `/.well-known/openid-configuration` — OIDC Discovery document
- `/.well-known/keys` — JWKS (RSA public key for JWT verification)
- `/authorize` — Authorization endpoint (shows login or auto-redirects if session exists)
- `/token` — Token exchange (POST, returns signed ID token)
- `/logout` — Logout (destroys session, redirects to post_logout_redirect_uri)
- `/idp/resetpassword` — Password reset placeholder

Use Next.js route handlers and/or rewrites in `next.config.js` to achieve this. For example:
- Route handlers at `app/authorize/route.ts`, `app/token/route.ts`, etc.
- Or route handlers under `app/api/oidc/` with rewrites from the standard paths

## Environment Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `APP_URL` | This app's public URL (used as JWT issuer) | `https://perspective-demo.vercel.app` |
| `TRADESTART_CALLBACK_URL` | TradeStart portal SSO callback URL | `https://staging.novusloyalty.com/api/auth/sso/callback` |
| `TRADESTART_LOGOUT_URL` | Where to redirect after IdP logout | `https://staging.novusloyalty.com/portal/login?code=tradestart` |
| `TRADESTART_PORTAL_URL` | TradeStart portal URL (for "Go to TradeStart" button) | `https://staging.novusloyalty.com/portal/login?code=tradestart` |
| `RSA_PRIVATE_KEY_JWK` | RSA private key in JWK JSON format | (generated by script) |
| `RSA_PUBLIC_KEY_JWK` | RSA public key in JWK JSON format | (generated by script) |
| `SESSION_SECRET` | Secret for signing session cookies (32+ chars) | (random string) |

## Design / Branding

- **Header:** Dark navy (`#1a1a2e`) background, white text, "Perspective" in bold
- **Accent color:** `#00AEEF` (blue — from Connect Homes palette)
- **Body font:** Inter or system font stack
- **Cards:** White background, subtle border (`border-gray-200`), rounded corners (`rounded-xl`)
- **TradeStart card accent:** Gold (`#FEC467`) left border or top accent bar
- Keep it simple and professional — this is a B2B construction platform
- No emojis

## Key Implementation Notes

1. **Auth codes are in-memory** — stored in a `Map`, expire after 60 seconds, single-use. This is fine for a demo — Vercel serverless may lose them on cold starts, but for testing that's acceptable.
2. **Sessions are cookie-based** — `perspective_session` httpOnly cookie containing a signed JWT (sign with SESSION_SECRET using HS256). JWT payload: `{ userId, email }`. 24h expiry.
3. **PKCE validation is required** — must verify `code_verifier` against stored `code_challenge` using SHA-256
4. **The `userprofiles` claim in the ID token is a JSON string** — `JSON.stringify()` the profile object before putting it in the JWT. This matches how the real PSTPF provider works.
5. **Audience (`aud`) in ID token must be LOWERCASE** — `3668f1e1-677d-414f-95ed-1cc789a92a85`
6. **No refresh tokens** — only ID tokens with 15 min expiry. The `expires_in` in the /token response is `9000` (seconds).
7. **Authorization Code flow only** — no implicit flow, no client credentials
8. **Silent SSO:** When `/authorize` is called and the user already has a valid `perspective_session` cookie, skip the login form and immediately redirect back with the auth code. This simulates the "already logged in" experience.
9. **RSA key pair:** Create a `scripts/generate-keys.ts` script that generates RSA-2048 keys using `jose` and outputs the JWK JSON strings ready to paste into Vercel env vars. For local dev, auto-generate keys on startup if env vars are missing.
10. **Registered client:** Only one client is registered — client_id `3668F1E1-677D-414F-95ED-1CC789A92A85`. Reject any /authorize or /token request with a different client_id.
